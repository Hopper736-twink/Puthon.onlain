<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Python P2P Studio ‚Äî fixed</title>

<!-- PeerJS (signaling server by PeerJS default) -->
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<!-- Prism for highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<style>
:root{
  --bg:#0d1117; --panel:#161b22; --accent:#58a6ff;
  --green:#238636; --muted:#9ba3ac; --border:#30363d; --text:#c9d1d9;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.header{
  display:flex;gap:10px;padding:10px;background:var(--panel);align-items:center;border-bottom:1px solid var(--border);
}
.btn{
  padding:10px 12px;border-radius:8px;border:0;color:#fff;font-weight:600;cursor:pointer;
}
.btn-run{background:var(--green)}
.btn-ai{background:var(--accent)}
.btn-net{background:#f39c12}
.title{font-weight:700;margin-right:auto}

.topline{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;font-size:13px;color:var(--muted);border-bottom:1px solid var(--border)}

.container{display:flex;flex-direction:column;height:calc(100% - 96px)} /* header+topline ~ 96 */
.editor-wrap{flex:1;position:relative;display:flex;min-height:0} /* min-height:0 for flex scroll */
.left{
  flex:1;position:relative;border-right:1px solid var(--border);display:flex;flex-direction:column;min-width:260px;
}
.editor{flex:1;position:relative;overflow:hidden}
/* IMPORTANT: textarea and pre must have identical font, padding, line-height and white-space rules */
.editor pre, .editor textarea{
  margin:0;padding:14px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  font-size:14px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;overflow:auto;height:100%;
  box-sizing:border-box;
}
.editor pre{
  position:relative;z-index:1;background:transparent;color:var(--text);border:0;outline:0;
}
.editor textarea{
  position:absolute;top:0;left:0;right:0;bottom:0;background:transparent;border:0;outline:none;resize:none;
  color:transparent; /* hide raw text; highlighted code shows underneath */
  caret-color:#fff; z-index:2;
  -webkit-text-fill-color: transparent; /* for webkit */
}

/* show line numbers area visually ‚Äî simple */
.gutter{width:56px;padding:10px 6px;border-right:1px solid var(--border);background:#0b0f14;color:var(--muted);font-family:monospace;font-size:13px;overflow:auto}
.right{
  width:36%;min-width:320px;display:flex;flex-direction:column;
}
.panel{padding:12px;border-bottom:1px solid var(--border);background:var(--panel);font-size:13px}
.console{height:220px;background:#000;color:#4af626;padding:12px;font-family:monospace;overflow:auto;border-top:1px solid var(--border);}

/* responsive */
@media (max-width:880px){
  .container{flex-direction:column}
  .right{width:100%;min-width:0}
  .left{border-right:0}
}
.small{font-size:12px;color:var(--muted)}
.input{padding:8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text)}
</style>
</head>
<body>

<div class="header">
  <div class="title">Python P2P Studio ‚Äî fixed</div>
  <button class="btn btn-run" id="runBtn">‚ñ∂ –ó–∞–ø—É—Å–∫</button>
  <button class="btn btn-ai" id="aiBtn">üß† Smart Local AI</button>
  <button class="btn btn-net" id="hostBtn">üåê –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
  <button class="btn btn-net" id="joinBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
</div>

<div class="topline">
  <div><span id="roomInfo">–ö–æ–º–Ω–∞—Ç–∞: ‚Äî</span> ¬∑ <span id="roleInfo">–†–æ–ª—å: ‚Äî</span></div>
  <div class="small">–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω: Pyodide –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. P2P —á–µ—Ä–µ–∑ PeerJS (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å STUN/TURN –≤ —Å–ª–æ–∂–Ω—ã—Ö NAT).</div>
</div>

<div class="container">
  <div style="display:flex;flex:1;min-height:0">
    <div class="left">
      <div style="display:flex">
        <div class="gutter" id="gutter">1</div>
        <div style="flex:1;display:flex;flex-direction:column">
          <div class="editor" id="editorHost">
            <pre><code id="highlight" class="language-python"></code></pre>
            <textarea id="editor" spellcheck="false">print("Python P2P Studio –≥–æ—Ç–æ–≤")</textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="roomInput" class="input" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã (–¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)" />
          <button class="btn" id="copyBtn" style="background:#2d3748">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="saveLocal" style="background:#2b6cb0">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
          <button class="btn" id="loadLocal" style="background:#805ad5">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button class="btn" id="clearConsole" style="background:#475569">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å</button>
        </div>
        <div style="margin-top:10px" class="small">
          –•–æ—Å—Ç —Å–æ–∑–¥–∞–µ—Ç –∫–æ–º–Ω–∞—Ç—É –∏ –¥–∞—ë—Ç ID. –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–≤–æ–¥—è—Ç ID –∏ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è. –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.
        </div>
      </div>

      <div class="panel small" id="aiPanel">
        <strong>Smart Local AI ‚Äî —á—Ç–æ –º–æ–∂–µ—Ç:</strong>
        <ul>
          <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (AST) –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
          <li>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π/–∫–ª–∞—Å—Å–æ–≤/–∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É</li>
          <li>–£–º–Ω–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ (–≤—Å—Ç–∞–≤–ª—è–µ—Ç, –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç)</li>
        </ul>
      </div>

      <div class="console" id="console">–ó–∞–≥—Ä—É–∑–∫–∞ Pyodide...</div>
    </div>
  </div>
</div>

<script>
/* ================= Initialization ================= */
let pyodide = null;
let peer = null;
let connections = []; // for host: array of DataConnections
let conn = null; // for viewer: single connection
let isHost = false;

const editor = document.getElementById('editor');
const highlightEl = document.getElementById('highlight');
const gutter = document.getElementById('gutter');
const consoleEl = document.getElementById('console');
const roomInfo = document.getElementById('roomInfo');
const roleInfo = document.getElementById('roleInfo');
const roomInput = document.getElementById('roomInput');

function logConsole(txt) {
  const time = new Date().toLocaleTimeString();
  consoleEl.textContent += `\n[${time}] ${txt}`;
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

/* Highlight and gutter sync */
function updateHighlight() {
  // ensure same text displayed
  highlightEl.textContent = editor.value + (editor.value.endsWith("\n") ? "" : "\n");
  Prism.highlightElement(highlightEl);
  updateGutter();
}
function updateGutter() {
  const lines = (editor.value.match(/\n/g) || []).length + 1;
  let s = "";
  for (let i=1;i<=lines;i++){ s += i + "\n"; }
  gutter.textContent = s;
}

/* Sync scroll */
editor.addEventListener('scroll', () => {
  const pre = highlightEl.parentElement;
  pre.scrollTop = editor.scrollTop;
  pre.scrollLeft = editor.scrollLeft;
});

/* prevent viewers from typing */
function setEditable(editable) {
  if (editable) {
    editor.removeAttribute('readonly');
    editor.style.cursor = 'text';
  } else {
    editor.setAttribute('readonly', 'true');
    editor.style.cursor = 'default';
  }
}

/* init view */
updateHighlight();
setEditable(true);

/* load pyodide */
(async function initPyodide(){
  try {
    consoleEl.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ Pyodide...";
    pyodide = await loadPyodide();
    // small helper: expose JS alert/prompt to python
    await pyodide.runPythonAsync(`
from js import console
`);
    consoleEl.textContent = ">>> Pyodide –≥–æ—Ç–æ–≤.";
    logConsole("Pyodide loaded");
  } catch(err) {
    consoleEl.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Pyodide: " + err;
    console.error(err);
  }
})();

/* ================= P2P (PeerJS) ================= */
function makeId() {
  return 'room-' + Math.random().toString(36).slice(2,9);
}

function createHost() {
  // destroy previous peer if exists
  if (peer && !peer.destroyed) {
    try { peer.destroy(); } catch(e){}
    peer = null;
    connections = [];
  }

  const id = makeId();
  peer = new Peer(id);
  isHost = true;
  roleInfo.textContent = "–†–æ–ª—å: HOST";
  roomInfo.textContent = "–ö–æ–º–Ω–∞—Ç–∞: " + id;
  roomInput.value = id;
  setEditable(true);
  logConsole("–°–æ–∑–¥–∞–Ω —Ö–æ—Å—Ç, ID = " + id);

  peer.on('open', (pid) => {
    logConsole("Peer opened: " + pid);
  });

  peer.on('connection', (c) => {
    logConsole("–ü–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫–ª–∏–µ–Ω—Ç: " + c.peer);
    connections.push(c);
    // send current content once opened:
    c.on('open', () => {
      try { c.send({type:'sync', code: editor.value}); } catch(e){}
    });
    // handle messages from clients (we ignore editing attempts)
    c.on('data', (data) => {
      logConsole(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${c.peer}: ` + JSON.stringify(data));
    });
    c.on('close', ()=> {
      logConsole(`–û—Ç–∫–ª—é—á–µ–Ω: ${c.peer}`);
      connections = connections.filter(x=>x !== c);
    });
    c.on('error', (e) => logConsole("Peer connection error: " + e));
  });

  peer.on('error', (err) => {
    logConsole("Peer error: " + err);
  });
}

function joinRoom(id) {
  if (!id || id.trim()==="") { alert("–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã"); return; }
  // destroy existing peer
  if (peer && !peer.destroyed) {
    try { peer.destroy(); } catch(e){}
    peer = null;
  }
  peer = new Peer();
  isHost = false;
  setEditable(false);
  roleInfo.textContent = "–†–æ–ª—å: VIEWER";
  roomInfo.textContent = "–ö–æ–º–Ω–∞—Ç–∞: " + id;
  logConsole("–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ " + id + " ...");

  peer.on('open', () => {
    conn = peer.connect(id, { reliable: true });
    conn.on('open', () => {
      logConsole("Connected to host: " + id);
      conn.on('data', (data) => {
        // expect object {type:'sync', code: '...'}
        if (data && data.type === 'sync') {
          editor.value = data.code;
          updateHighlight();
          logConsole("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ –æ—Ç —Ö–æ—Å—Ç–∞");
        } else if (typeof data === 'string') {
          editor.value = data;
          updateHighlight();
        }
      });
    });
    conn.on('error', (e) => logConsole("Connection error: " + e));
    conn.on('close', ()=> logConsole("Connection closed"));
  });

  peer.on('error', (err) => logConsole("Peer error: " + err));
}

function broadcastToClients(obj) {
  // only host
  connections.forEach(c => {
    try { c.send(obj); } catch(e) { console.warn(e); }
  });
}

/* Buttons */
document.getElementById('hostBtn').addEventListener('click', ()=>{
  createHost();
});
document.getElementById('joinBtn').addEventListener('click', ()=>{
  const id = roomInput.value.trim() || prompt("–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã:");
  if (id) joinRoom(id);
});
document.getElementById('copyBtn').addEventListener('click', ()=>{
  const id = roomInput.value.trim();
  if (!id) return alert("–ù–µ—Ç ID –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è");
  navigator.clipboard?.writeText(id).then(()=>alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"));
});
/* when host edits, broadcast */
editor.addEventListener('input', () => {
  updateHighlight();
  if (isHost) {
    broadcastToClients({type:'sync', code: editor.value});
  }
});

/* Save/load local */
document.getElementById('saveLocal').addEventListener('click', ()=>{
  localStorage.setItem('p2p_code', editor.value);
  alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ');
});
document.getElementById('loadLocal').addEventListener('click', ()=>{
  const v = localStorage.getItem('p2p_code');
  if (v === null) return alert('–õ–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—Ç');
  editor.value = v;
  updateHighlight();
  if (isHost) broadcastToClients({type:'sync', code: editor.value});
});

/* clear console */
document.getElementById('clearConsole').addEventListener('click', ()=>{
  consoleEl.textContent = '';
});

/* Run python button */
document.getElementById('runBtn').addEventListener('click', runPython);

async function runPython() {
  if (!pyodide) { alert("Pyodide –Ω–µ –≥–æ—Ç–æ–≤"); return; }
  consoleEl.textContent = ">>> –ó–∞–ø—É—Å–∫...\n";
  try {
    // set up safe stdout capture
    await pyodide.runPythonAsync(`
import sys, io
sys.stdout = io.StringIO()
sys.stderr = io.StringIO()
`);
    const code = editor.value;
    await pyodide.runPythonAsync(code);
    const out = pyodide.runPython('sys.stdout.getvalue() + "\\n" + sys.stderr.getvalue()');
    consoleEl.textContent += out || "–í—ã–ø–æ–ª–Ω–µ–Ω–æ.";
  } catch (err) {
    consoleEl.textContent += "–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:\n" + err;
  }
}

/* ================ SMART LOCAL AI ================ */
/*
Behavior:
- If user asks to "–∏—Å–ø—Ä–∞–≤–∏—Ç—å" -> run AST parse via Pyodide; show trace and attempt common fixes (print(...) etc.)
- If user asks to "—Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é/–∫–ª–∞—Å—Å/—Ñ–∏–±/—Å–æ—Ä—Ç" -> append a template near cursor
- Always works offline; uses Pyodide for syntax checks (better than simple regex)
*/
document.getElementById('aiBtn').addEventListener('click', smartLocalAI);

async function smartLocalAI() {
  const task = prompt("Smart AI ‚Äî –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É (–Ω–∞ —Ä—É—Å—Å–∫–æ–º):\n–ü—Ä–∏–º–µ—Ä—ã: '–∏—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏', '—Å–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞', '–¥–æ–±–∞–≤—å –∫–ª–∞—Å—Å', '–¥–æ–±–∞–≤—å –∞–ª–≥–æ—Ä–∏—Ç–º —Ñ–∏–±–æ–Ω–∞—á–∏')");
  if (!task) return;
  logConsole("AI: " + task);

  // 1) –ï—Å–ª–∏ –ø—Ä–æ—Å—å–±–∞ –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º AST
  if (/–∏—Å–ø—Ä–∞–≤|–æ—à–∏–±|syntax|–ø–∞—Ä—Å/i.test(task)) {
    if (!pyodide) { alert("Pyodide –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏."); return; }
    const code = editor.value;
    // Prepare Python snippet to check ast and return traceback string
    const pyCheck = `
import ast,traceback,json
code = ${JSON.stringify(code)}
try:
    ast.parse(code)
    result = {"ok": True, "message": "OK"}
except Exception as e:
    result = {"ok": False, "message": traceback.format_exc()}
json.dumps(result)
`;
    try {
      const resJson = await pyodide.runPythonAsync(pyCheck);
      const res = JSON.parse(resJson);
      if (res.ok) {
        logConsole("AST: —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü–æ–ø—Ä–æ–±—É—é –Ω–∞–π—Ç–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è...");
        // basic suggestions: if 'print ' without parentheses -> offer fix
        if (/^\s*print\s+["'`]/m.test(code)) {
          const fixed = code.replace(/^\s*print\s+([^\n]+)/gm, 'print(\\1)');
          const apply = confirm("–ù–∞–π–¥–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ print –±–µ–∑ —Å–∫–æ–±–æ–∫. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ?");
          if (apply) {
            editor.value = fixed;
            updateHighlight();
            if (isHost) broadcastToClients({type:'sync', code: editor.value});
            logConsole("–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ: print -> print(...)");
          }
        } else {
          alert("–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ. –ú–æ–≥—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏/–∫–ª–∞—Å—Å—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É.");
        }
      } else {
        // show traceback and attempt common fixes
        logConsole("AST –æ—à–∏–±–∫–∏:\n" + res.message);
        // Try quick fixes heuristics:
        let fixed = code;
        let changed = false;
        // heuristic: fix print without parentheses
        if (/^\s*print\s+["'`]/m.test(code)) {
          fixed = fixed.replace(/^\s*print\s+([^\n]+)/gm, 'print(\\1)');
          changed = true;
        }
        // heuristic: replace Python2 division? don't force.
        if (changed) {
          const apply = confirm("–ù–∞–π–¥–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä print()). –ü—Ä–∏–º–µ–Ω–∏—Ç—å?");
          if (apply) {
            editor.value = fixed;
            updateHighlight();
            if (isHost) broadcastToClients({type:'sync', code: editor.value});
            logConsole("AI applied quick fixes");
          }
        } else {
          alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Å—Ç—ã—Ö –∞–≤—Ç–æ-–ø—Ä–∞–≤–æ–∫. –û—à–∏–±–∫–∞ –≤ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–µ:\n\n" + res.message);
        }
      }
    } catch (e) {
      logConsole("AI check error: " + e);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞: " + e);
    }
    return;
  }

  // 2) Generation requests (function/class/algorithms)
  const lower = task.toLowerCase();
  let snippet = "\n# AI: –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç\n";
  if (/—Ñ—É–Ω–∫—Ü|function|function/i.test(lower) || /—Ñ—É–Ω–∫/i.test(lower)) {
    snippet += "def new_function(arg1, arg2):\n    \"\"\"–û–ø–∏—Å–∞–Ω–∏–µ: –∑–∞–º–µ–Ω–∏—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ —Ç–µ–ª–æ\"\"\"\n    # TODO: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è\n    return None\n";
  } else if (/–∫–ª–∞—Å—Å|class/i.test(lower)) {
    snippet += "class NewClass:\n    def __init__(self, value=None):\n        self.value = value\n    def __repr__(self):\n        return f\"NewClass({self.value})\"\n";
  } else if (/—Ñ–∏–±|fibo/i.test(lower)) {
    snippet += "def fib(n):\n    a,b = 0,1\n    for _ in range(n):\n        a,b = b,a+b\n    return a\n";
  } else if (/—Å–æ—Ä—Ç|sort/i.test(lower)) {
    snippet += "def quicksort(arr):\n    if len(arr) <= 1: return arr\n    pivot = arr[len(arr)//2]\n    left = [x for x in arr if x < pivot]\n    mid = [x for x in arr if x == pivot]\n    right = [x for x in arr if x > pivot]\n    return quicksort(left) + mid + quicksort(right)\n";
  } else {
    // generic: try to produce a function based on task
    snippet += `# –ó–∞–¥–∞—á–∞: ${task}\ndef task_solution(*args, **kwargs):\n    \"\"\"–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É: ${task}\"\"\"\n    pass\n`;
  }

  // Insert snippet at cursor or append
  const pos = editor.selectionStart || editor.value.length;
  const before = editor.value.slice(0, pos);
  const after = editor.value.slice(pos);
  editor.value = before + "\n" + snippet + "\n" + after;
  updateHighlight();
  if (isHost) broadcastToClients({type:'sync', code: editor.value});
  logConsole("AI inserted snippet");
}

/* initial highlight */
updateHighlight();
</script>

</body>
</html>
