<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Python P2P Studio</title>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>

<style>
:root {
  --bg:#0d1117; --panel:#161b22; --accent:#58a6ff;
  --green:#238636; --border:#30363d; --text:#c9d1d9;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:system-ui; height:100vh; display:flex; flex-direction:column;
}
.toolbar{
  display:flex; gap:6px; padding:8px; background:var(--panel);
}
button{
  flex:1; padding:12px; border:0; border-radius:8px;
  font-weight:600; color:#fff; cursor:pointer;
}
.run{background:var(--green)}
.ai{background:var(--accent)}
.net{background:#f39c12}

.status{
  padding:6px 12px; font-size:12px;
  display:flex; justify-content:space-between;
  border-bottom:1px solid var(--border);
}

.editor-wrap{flex:1; position:relative}
textarea, pre{
  margin:0; padding:14px; width:100%; height:100%;
  font-family:monospace; font-size:15px; line-height:1.5;
}
textarea{
  background:transparent; color:transparent;
  caret-color:#fff; position:absolute; z-index:2;
  border:0; resize:none; outline:none;
}
pre{
  position:absolute; z-index:1; overflow:auto;
}
.console{
  height:25%; background:#000; color:#4af626;
  padding:10px; font-size:13px; overflow:auto;
}
</style>
</head>

<body>

<div class="toolbar">
  <button class="run" onclick="runCode()">‚ñ∂ –ó–∞–ø—É—Å–∫</button>
  <button class="ai" onclick="localAI()">üß† Local AI</button>
  <button class="net" onclick="connect()">üåê –°–µ—Ä–≤–µ—Ä</button>
</div>

<div class="status">
  <span id="srv">–ö–æ–º–Ω–∞—Ç–∞: ‚Äî</span>
  <span id="role">–†–æ–ª—å: ‚Äî</span>
</div>

<div class="editor-wrap">
<pre><code id="hl" class="language-python"></code></pre>
<textarea id="ed">print("Python P2P Studio –≥–æ—Ç–æ–≤")</textarea>
</div>

<div class="console" id="out">–ó–∞–≥—Ä—É–∑–∫–∞ Python...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<script>
let py, peer, conns=[], isHost=false;
const ed=document.getElementById("ed");
const hl=document.getElementById("hl");
const out=document.getElementById("out");

function sync(){
  hl.textContent=ed.value+"\n";
  Prism.highlightElement(hl);
}
ed.oninput=()=>{ if(isHost) broadcast(ed.value); sync(); };

async function init(){
  py=await loadPyodide();
  out.textContent=">>> Python –≥–æ—Ç–æ–≤";
  sync();
}
init();

/* ---------- P2P ---------- */
function connect(){
  const mode=prompt("host / join?");
  if(mode==="host"){
    isHost=true;
    const id="room-"+Math.random().toString(36).slice(2,8);
    peer=new Peer(id);
    document.getElementById("srv").textContent="–ö–æ–º–Ω–∞—Ç–∞: "+id;
    document.getElementById("role").textContent="–†–æ–ª—å: HOST";
    peer.on("connection",c=>{
      conns.push(c);
      c.on("open",()=>c.send(ed.value));
    });
  }
  if(mode==="join"){
    const id=prompt("ID –∫–æ–º–Ω–∞—Ç—ã:");
    peer=new Peer();
    peer.on("open",()=>{
      const c=peer.connect(id);
      c.on("data",d=>{ ed.value=d; sync(); });
      document.getElementById("role").textContent="–†–æ–ª—å: VIEWER";
      ed.addEventListener("keydown",e=>e.preventDefault());
    });
  }
}

function broadcast(val){
  conns.forEach(c=>c.send(val));
}

/* ---------- Local AI ---------- */
function localAI(){
  const q=prompt("–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?");
  let r="# –ù–µ –ø–æ–Ω—è–ª ü§ñ";
  if(q.includes("—Ü–∏–∫–ª")) r="for i in range(5):\n    print(i)";
  if(q.includes("—Ñ—É–Ω–∫")) r="def func(x):\n    return x*2";
  if(q.includes("–∫–ª–∞—Å—Å")) r="class Test:\n    def __init__(self):\n        pass";
  if(isHost){ ed.value=r; sync(); broadcast(r); }
}

/* ---------- Python ---------- */
async function runCode(){
  out.textContent=">>> –ó–∞–ø—É—Å–∫...\n";
  try{
    await py.runPythonAsync(`
import sys,io
sys.stdout=io.StringIO()
`);
    await py.runPythonAsync(ed.value);
    out.textContent+=py.runPython("sys.stdout.getvalue()");
  }catch(e){ out.textContent+=e; }
}
</script>

</body>
</html>
