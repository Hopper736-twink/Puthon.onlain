<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Python Cloud Studio FIXED</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --green: #238636; --text: #c9d1d9; --border: #30363d; }
        
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100vh; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        
        .toolbar { background: var(--panel); padding: 8px; display: flex; gap: 6px; border-bottom: 1px solid var(--border); }
        button { border: none; padding: 10px 12px; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; color: white; }
        .btn-run { background: var(--green); flex: 1; }
        .btn-ai { background: var(--accent); flex: 1; }
        .btn-srv { background: #f39c12; }

        .status-bar { background: #000; padding: 4px 10px; font-size: 10px; color: #888; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .role-admin { color: #ff4757; font-weight: bold; }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –†–ï–î–ê–ö–¢–û–† */
        .editor-container { flex: 1; position: relative; background: var(--bg); overflow: hidden; }
        
        /* –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ */
        #editor, #highlighting {
            margin: 0; padding: 20px; border: 0; width: 100%; height: 100%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 16px !important; line-height: 1.5 !important;
            position: absolute; top: 0; left: 0;
            white-space: pre !important; word-spacing: normal !important;
            word-break: normal !important; tab-size: 4;
        }

        #editor {
            color: transparent !important; background: transparent !important;
            caret-color: #fff !important; z-index: 2; resize: none; outline: none;
            overflow: auto; -webkit-text-fill-color: transparent;
        }

        #highlighting { z-index: 1; pointer-events: none; overflow: hidden; }
        #hl-content { font-family: inherit !important; font-size: inherit !important; }

        #console { height: 25%; background: #000; color: #4af626; padding: 12px; font-family: monospace; font-size: 13px; overflow-y: auto; border-top: 2px solid var(--border); }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn-run" onclick="runCode()">‚ñ∂ –ó–ê–ü–£–°–ö</button>
        <button class="btn-ai" onclick="askAI()">‚ú® –ò–ò</button>
        <button class="btn-srv" onclick="joinServer()">üåê –°–ï–†–í–ï–†</button>
    </div>

    <div class="status-bar">
        <span id="srv-status">–†–µ–∂–∏–º: –õ–æ–∫–∞–ª—å–Ω—ã–π</span>
        <span id="role-status">–†–æ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
    </div>

    <div class="editor-container">
        <pre id="highlighting" aria-hidden="true"><code class="language-python" id="hl-content"></code></pre>
        <textarea id="editor" spellcheck="false" oninput="handleInput(this.value)" onscroll="syncScroll(this)">print("–ë–∞–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!")</textarea>
    </div>

    <div id="console">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<script>
    // –ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ—é —Å—Å—ã–ª–∫—É Firebase –∑–¥–µ—Å—å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    const fbConfig = { databaseURL: "https://python-collab-default-rtdb.firebaseio.com/" };
    let py, dbRef;
    let isServer = false;
    let isAdmin = false;
    
    const editor = document.getElementById('editor');
    const hlContent = document.getElementById('hl-content');
    const highlighting = document.getElementById('highlighting');
    const out = document.getElementById('console');

    async function init() {
        try {
            py = await loadPyodide();
            out.innerText = ">>> Python –≥–æ—Ç–æ–≤.";
            updateUI(editor.value);
        } catch(e) { out.innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."; }
    }
    init();

    function updateUI(val) {
        editor.value = val;
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –≤ –∫–æ–Ω—Ü–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
        hlContent.textContent = val + (val.endsWith("\n") ? " " : "");
        Prism.highlightElement(hlContent);
    }

    function handleInput(val) {
        if (isServer && !isAdmin) {
            // –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            dbRef.once('value', (s) => updateUI(s.val().code));
            alert("–í—ã —Ç–æ–ª—å–∫–æ –∑—Ä–∏—Ç–µ–ª—å!");
            return; 
        }
        updateUI(val);
        if (isServer && isAdmin) {
            dbRef.set({ code: val });
        }
    }

    function syncScroll(el) {
        highlighting.scrollTop = el.scrollTop;
        highlighting.scrollLeft = el.scrollLeft;
    }

    function joinServer() {
        const code = prompt("–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞:");
        if (code === "Max") {
            if (!firebase.apps.length) firebase.initializeApp(fbConfig);
            isServer = true;
            dbRef = firebase.database().ref('rooms/public_server');
            document.getElementById('srv-status').innerText = "–†–µ–∂–∏–º: –°–ï–†–í–ï–† (Max)";
            
            dbRef.on('value', (snap) => {
                const data = snap.val();
                if (data && !isAdmin) updateUI(data.code);
            });
            out.innerText = ">>> –ü–æ–¥–∫–ª—é—á–µ–Ω–æ. –ñ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∞.";
        }
    }

    async function askAI() {
        const task = prompt("–ó–∞–ø—Ä–æ—Å –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞:");
        if (!task) return;
        if (task === "code hop") {
            isAdmin = true;
            document.getElementById('role-status').innerHTML = '–†–æ–ª—å: <span class="role-admin">ADMIN</span>';
            return;
        }
        // –¢—É—Ç —Ç–≤–æ—è –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ò–ò...
    }

    async function runCode() {
        if (!py) return;
        out.innerText = ">>> –ó–∞–ø—É—Å–∫...\n";
        try {
            await py.runPythonAsync(`import sys, io\nsys.stdout = io.StringIO()\nfrom js import window\n__builtins__.input = window.prompt`);
            await py.runPythonAsync(editor.value);
            out.innerText += py.runPython("sys.stdout.getvalue()") || "–í—ã–ø–æ–ª–Ω–µ–Ω–æ.";
        } catch(e) { out.innerText += "\n–û—à–∏–±–∫–∞:\n" + e; }
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
