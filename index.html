<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Python P2P Studio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --green: #238636; --text: #c9d1d9; --border: #30363d; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100vh; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        .toolbar { background: var(--panel); padding: 8px; display: flex; gap: 6px; border-bottom: 1px solid var(--border); }
        button { border: none; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; color: white; }
        .btn-run { background: var(--green); flex: 1; }
        .btn-ai { background: var(--accent); flex: 1; }
        .btn-srv { background: #f39c12; flex: 1; }
        .status-bar { background: #000; padding: 4px 10px; font-size: 10px; color: #888; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .editor-container { flex: 1; position: relative; background: var(--bg); }
        #editor, #highlighting { margin: 0; padding: 15px; border: 0; width: 100%; height: 100%; font-family: monospace; font-size: 16px; line-height: 1.5; position: absolute; top: 0; left: 0; white-space: pre; tab-size: 4; }
        #editor { color: transparent; background: transparent; caret-color: #fff; z-index: 2; resize: none; outline: none; overflow: auto; -webkit-text-fill-color: transparent; }
        #highlighting { z-index: 1; pointer-events: none; overflow: hidden; }
        #console { height: 25%; background: #000; color: #4af626; padding: 12px; font-size: 13px; overflow-y: auto; border-top: 1px solid var(--border); }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn-run" onclick="runCode()">‚ñ∂ –ó–ê–ü–£–°–ö</button>
        <button class="btn-ai" onclick="askAI()">‚ú® –ò–ò</button>
        <button class="btn-srv" onclick="joinServer()">üåê –°–ï–†–í–ï–†</button>
    </div>

    <div class="status-bar">
        <span id="srv-status">ID: –ì–µ–Ω–µ—Ä–∏—Ä—É—é...</span>
        <span id="role-status">–†–æ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
    </div>

    <div class="editor-container">
        <pre id="highlighting" aria-hidden="true"><code class="language-python" id="hl-content"></code></pre>
        <textarea id="editor" spellcheck="false" oninput="handleInput(this.value)" onscroll="syncScroll(this)">print("–°–∏—Å—Ç–µ–º–∞ P2P –≥–æ—Ç–æ–≤–∞")</textarea>
    </div>

    <div id="console">–ó–∞–≥—Ä—É–∑–∫–∞ Python...</div>

<script>
    let py, peer, conn;
    let isAdmin = false;
    const editor = document.getElementById('editor');
    const out = document.getElementById('console');

    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Python
    async function init() {
        try {
            py = await loadPyodide();
            out.innerText = ">>> Python –≥–æ—Ç–æ–≤.";
            updateUI(editor.value);
            initPeer();
        } catch(e) { out.innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."; }
    }
    init();

    // 2. –õ–æ–≥–∏–∫–∞ P2P –°–µ—Ä–≤–µ—Ä–∞
    function initPeer() {
        // –°–æ–∑–¥–∞–µ–º ID —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–¥–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞ Max
        peer = new Peer('python-server-max-' + Math.floor(Math.random()*100));
        
        peer.on('open', (id) => {
            document.getElementById('srv-status').innerText = "ID: " + id;
        });

        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (data) => {
                if (!isAdmin) updateUI(data);
            });
        });
    }

    function joinServer() {
        const code = prompt("–í–≤–µ–¥–∏—Ç–µ ID —Å–µ—Ä–≤–µ—Ä–∞ (–∏–ª–∏ 'Max' –¥–ª—è –∞–≤—Ç–æ-–ø–æ–∏—Å–∫–∞):");
        if (code === "Max") {
            const targetId = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π ID (–∏–∑ —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥—Ä—É–≥–∞):");
            conn = peer.connect(targetId);
            conn.on('open', () => {
                out.innerText = ">>> –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ " + targetId;
                conn.on('data', (data) => { if(!isAdmin) updateUI(data); });
            });
        }
    }

    // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–æ–º
    function updateUI(val) {
        editor.value = val;
        document.getElementById('hl-content').textContent = val + (val.endsWith("\n") ? " " : "");
        Prism.highlightElement(document.getElementById('hl-content'));
    }

    function handleInput(val) {
        if (conn && !isAdmin && peer.connections.length > 0) {
            updateUI(editor.value); // –û—Ç–∫–∞—Ç –µ—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω
            return;
        }
        updateUI(val);
        if (isAdmin && conn) conn.send(val);
    }

    // 4. –ò–ò —Å —Ñ–∏–∫—Å–æ–º
    async function askAI() {
        const task = prompt("–ò–ò: code hop (–∞–¥–º–∏–Ω) –∏–ª–∏ –≤–∞—à –∑–∞–ø—Ä–æ—Å:");
        if (task === "code hop") {
            isAdmin = true;
            document.getElementById('role-status').innerText = "–†–æ–ª—å: ADMIN";
            return;
        }

        let key = localStorage.getItem('op_key_vfinal');
        if (!key) { key = prompt("–í—Å—Ç–∞–≤—å—Ç–µ API Key:"); localStorage.setItem('op_key_vfinal', key); }

        out.innerText = ">>> –ò–ò –¥—É–º–∞–µ—Ç...";
        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${key}`,
                    "Content-Type": "application/json" 
                },
                body: JSON.stringify({
                    "model": "google/gemini-2.0-flash-exp:free",
                    "messages": [{"role": "user", "content": task + "\n–ü–∏—à–∏ –¢–û–õ–¨–ö–û –∫–æ–¥ Python –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π:\n" + editor.value}]
                })
            });
            const data = await response.json();
            const newCode = data.choices[0].message.content.replace(/```python|```/g, "").trim();
            handleInput(newCode);
            out.innerText = ">>> –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω.";
        } catch(e) { out.innerText = "–û—à–∏–±–∫–∞ –ò–ò. –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á."; }
    }

    function syncScroll(el) { document.getElementById('highlighting').scrollTop = el.scrollTop; }
    
    async function runCode() {
        if (!py) return;
        out.innerText = ">>> –ó–∞–ø—É—Å–∫...\n";
        try {
            await py.runPythonAsync(`import sys, io\nsys.stdout = io.StringIO()\nfrom js import window\n__builtins__.input = window.prompt`);
            await py.runPythonAsync(editor.value);
            out.innerText += py.runPython("sys.stdout.getvalue()") || "–í—ã–ø–æ–ª–Ω–µ–Ω–æ.";
        } catch(e) { out.innerText += "\n–û—à–∏–±–∫–∞:\n" + e; }
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
