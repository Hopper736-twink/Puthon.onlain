<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Python Cloud Studio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --green: #238636; --text: #c9d1d9; --border: #30363d; }
        body, html { margin: 0; padding: 0; height: 100vh; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        .toolbar { background: var(--panel); padding: 8px; display: flex; gap: 6px; border-bottom: 1px solid var(--border); }
        button { border: none; padding: 10px 12px; border-radius: 6px; font-weight: bold; font-size: 11px; cursor: pointer; color: white; }
        .btn-run { background: var(--green); flex: 1; }
        .btn-ai { background: var(--accent); flex: 1; }
        .btn-srv { background: #f39c12; }
        .status-bar { background: #000; padding: 4px 10px; font-size: 10px; color: #888; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .role-admin { color: #ff4757; font-weight: bold; }
        .editor-container { flex: 1; position: relative; }
        #editor, #highlighting { margin: 0; padding: 15px; border: 0; width: 100%; height: 100%; font-family: monospace; font-size: 14px; position: absolute; top: 0; left: 0; box-sizing: border-box; tab-size: 4; }
        #editor { color: transparent; background: transparent; caret-color: #fff; z-index: 2; resize: none; outline: none; white-space: pre; }
        #highlighting { z-index: 1; white-space: pre; pointer-events: none; overflow: hidden; }
        #console { height: 25%; background: #000; color: #4af626; padding: 12px; font-size: 13px; overflow-y: auto; border-top: 1px solid var(--border); }
    </style>
</head>
<body>

    <div class="toolbar">
        <button class="btn-run" onclick="runCode()">‚ñ∂ –ó–ê–ü–£–°–ö</button>
        <button class="btn-ai" onclick="askAI()">‚ú® –ò–ò</button>
        <button class="btn-srv" onclick="joinServer()">üåê –°–ï–†–í–ï–†</button>
    </div>

    <div class="status-bar">
        <span id="srv-status">–†–µ–∂–∏–º: –õ–æ–∫–∞–ª—å–Ω—ã–π</span>
        <span id="role-status">–†–æ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
    </div>

    <div class="editor-container">
        <pre id="highlighting" aria-hidden="true"><code class="language-python" id="hl-content"></code></pre>
        <textarea id="editor" spellcheck="false" oninput="handleInput(this.value)" onscroll="syncScroll(this)">print("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!")</textarea>
    </div>

    <div id="console">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<script>
    const fbConfig = { databaseURL: "https://python-collab-default-rtdb.firebaseio.com/" };
    let py, dbRef;
    let isServer = false;
    let isAdmin = false;
    
    const editor = document.getElementById('editor');
    const hlContent = document.getElementById('hl-content');
    const out = document.getElementById('console');

    async function init() {
        try {
            py = await loadPyodide();
            out.innerText = ">>> Python –≥–æ—Ç–æ–≤.";
        } catch(e) { out.innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."; }
    }
    init();

    function updateUI(val) {
        editor.value = val;
        hlContent.textContent = val + (val.endsWith("\n") ? " " : "");
        Prism.highlightElement(hlContent);
    }

    function handleInput(val) {
        if (isServer && !isAdmin) {
            alert("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ!");
            return; 
        }
        updateUI(val);
        if (isServer && isAdmin) {
            dbRef.set({ code: val });
        }
    }

    function joinServer() {
        const code = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É:");
        if (code === "Max") {
            if (!firebase.apps.length) firebase.initializeApp(fbConfig);
            isServer = true;
            dbRef = firebase.database().ref('rooms/public_server');
            document.getElementById('srv-status').innerText = "–†–µ–∂–∏–º: –°–ï–†–í–ï–† (Max)";
            
            dbRef.on('value', (snap) => {
                const data = snap.val();
                if (data && !isAdmin) updateUI(data.code);
            });
            out.innerText = ">>> –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É Max. –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.";
        } else {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!");
        }
    }

    async function askAI() {
        const task = prompt("–ò–ò: –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–µ–∫—Ä–µ—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É:");
        if (!task) return;

        if (task === "code hop") {
            isAdmin = true;
            document.getElementById('role-status').innerHTML = '–†–æ–ª—å: <span class="role-admin">ADMIN</span>';
            alert("–î–æ—Å—Ç—É–ø –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∫–æ–¥–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.");
            return;
        }

        // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ò–ò
        let key = localStorage.getItem('op_key');
        if (!key) { key = prompt("API Key:"); localStorage.setItem('op_key', key); }
        
        out.innerText = ">>> –ò–ò –¥—É–º–∞–µ—Ç...";
        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": "Bearer " + key, "Content-Type": "application/json" },
                body: JSON.stringify({
                    "model": "google/gemini-2.0-flash-exp:free",
                    "messages": [{"role": "user", "content": task + "\n–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –∫–æ–¥ Python –¥–ª—è:\n" + editor.value}]
                })
            });
            const data = await res.json();
            handleInput(data.choices[0].message.content.replace(/```python|```/g, "").trim());
            out.innerText = ">>> –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω.";
        } catch(e) { out.innerText = "–û—à–∏–±–∫–∞ –ò–ò."; }
    }

    function syncScroll(el) { document.getElementById('highlighting').scrollTop = el.scrollTop; }
    
    async function runCode() {
        if (!py) return;
        out.innerText = ">>> –ó–∞–ø—É—Å–∫...\n";
        try {
            await py.runPythonAsync(`import sys, io\nsys.stdout = io.StringIO()\nfrom js import window\n__builtins__.input = window.prompt`);
            await py.runPythonAsync(editor.value);
            out.innerText += py.runPython("sys.stdout.getvalue()") || "–í—ã–ø–æ–ª–Ω–µ–Ω–æ.";
        } catch(e) { out.innerText += "\n–û—à–∏–±–∫–∞:\n" + e; }
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
